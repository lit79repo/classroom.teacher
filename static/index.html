<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">
    <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
    <link href="/lib/@mdi/font/css/materialdesignicons.min.css" rel="stylesheet">
    <link href="/lib/vuetify/dist/vuetify.min.css" rel="stylesheet">
    <style>
        #notification {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 200px;
            padding: 20px;
            border-radius: 5px;
            background-color: white;
            box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2);
        }
        .hidden {
            display: none;
        }
    </style>
    <title>79 | Classroom | Teacher</title>
</head>

<body>
    <div id="app">
        <v-app>
            <v-content style="background: whitesmoke;">
                <v-toolbar color="indigo" dark>

                    <v-toolbar-title>Лицей №79 / Учитель класса </v-toolbar-title>

                    <v-spacer></v-spacer>
                    <v-btn @click='refresh'>Обновить информацию</v-btn>
                    <v-spacer></v-spacer>
                    <a style="color: white;" href="http://marinenko.rf.gd" target="_blank">
                        <h5>Copyright (c) 2019 Misha Marinenko / {{version}}</h5>
                    </a>
                </v-toolbar>

                <v-container fluid>
                    <v-row dense>
                        <v-col v-for="machine in machines" :key="machine.hostname" rows="5" cols="6">
                            <v-card min-width="350px" elevation="5">
                                <v-img :src="'http://'+machine.ip+':7979/screenshot'" class="white--text align-end"
                                    gradient="to bottom, rgba(0,0,0,.1), rgba(0,0,0,.5)" height="200px">
                                    <v-card-title v-text="(machine.hostname ? machine.hostname : machine.ip)"></v-card-title>
                                </v-img>
                                </v-card-title>
                                <v-card-actions>
                                    <v-btn @click="lock((machine.hostname ? machine.hostname : machine.ip))" icon>
                                        <v-icon>mdi-lock</v-icon>
                                    </v-btn>
                                    <v-btn @click="unlock((machine.hostname ? machine.hostname : machine.ip))" icon>
                                        <v-icon>mdi-lock-open</v-icon>
                                    </v-btn>
                                    <v-spacer></v-spacer>
                                    <v-btn @click="vnc((machine.hostname ? machine.hostname : machine.ip))" icon>
                                        <v-icon>mdi-devices</v-icon>
                                    </v-btn>
                                    <v-spacer></v-spacer>
                                    <a target="_system"
                                        :href="'http://'+(machine.hostname ? machine.hostname : machine.ip)+':7979/filemanager'">
                                        <v-btn icon>
                                            <v-icon>mdi-folder</v-icon>
                                        </v-btn>
                                    </a>
                                </v-card-actions>
                            </v-card>
                        </v-col>
                    </v-row>
                </v-container>
            </v-content>
        </v-app>
        <p id="version"></p>
        <div id="notification" class="hidden">
            <p id="message"></p>
            <button id="close-button" onClick="closeNotification()">
                Close
            </button>
            <button id="restart-button" onClick="restartApp()" class="hidden">
                Restart
            </button>
        </div>
    </div>

    <script src="/lib/vue/dist/vue.js"></script>
    <script src="/lib/vuetify/dist/vuetify.js"></script>
    <script>
        window.app = new Vue({
            el: '#app',
            vuetify: new Vuetify(),
            data: {
                machines: [],
                version: ""
            },
            methods: {
                async fetchMachines() {
                    const Fetch = await fetch("/machines");
                    const response = await Fetch.json();
                    this.machines = response;
                    this.machines.sort((a, b) => a.hostname.localeCompare((b.hostname ? b.hostname : b.ip)));
                    return response;
                },
                async lock(host) {
                    const Fetch = await fetch("http://" + host + ":7979/lock");
                    // const response = await Fetch.json();
                    // this.machines = response;
                    return Fetch;
                },
                async unlock(host) {
                    const Fetch = await fetch("http://" + host + ":7979/unlock");
                    // const response = await Fetch.json();
                    // this.machines = response;
                    return Fetch;
                },
                async vnc(host) {
                    const Fetch = await fetch("/vnc/" + host);
                    // this.machines = response;
                    return Fetch;
                },
                refresh() {
                    location.href=location.href
                }
            },
            created() {
                this.fetchMachines();
                setInterval(this.fetchMachines(), 1000);
            }
        })
    </script>
    <script>
        const { ipcRenderer } = require('electron');
        const version = document.getElementById('version');

        ipcRenderer.send('app_version');
        ipcRenderer.on('app_version', (event, arg) => {
            ipcRenderer.removeAllListeners('app_version');
            app.$data.version = arg.version;
        });
        const notification = document.getElementById('notification');
        const message = document.getElementById('message');
        const restartButton = document.getElementById('restart-button');
        ipcRenderer.on('update_available', () => {
            ipcRenderer.removeAllListeners('update_available');
            message.innerText = 'A new update is available. Downloading now...';
            notification.classList.remove('hidden');
        });
        ipcRenderer.on('update_downloaded', () => {
            ipcRenderer.removeAllListeners('update_downloaded');
            message.innerText = 'Update Downloaded. It will be installed on restart. Restart now?';
            restartButton.classList.remove('hidden');
            notification.classList.remove('hidden');
        });
        function closeNotification() {
            notification.classList.add('hidden');
        }
        function restartApp() {
            ipcRenderer.send('restart_app');
        }
    </script>
</body>

</html>